version: '3.8'

services:
  # ================================
  # API Gateway
  # ================================
  api-gateway:
    build: ./apps/api-gateway
    container_name: taskflow-api-gateway
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-15m}
      - AUTH_SERVICE_URL=http://auth-service:3001
      - TASKS_SERVICE_URL=http://tasks-service:3002
      - NOTIFICATIONS_SERVICE_URL=http://notifications-service:3003
      - CORS_ORIGIN=${CORS_ORIGIN}
      - THROTTLE_TTL=${THROTTLE_TTL:-60}
      - THROTTLE_LIMIT=${THROTTLE_LIMIT:-100}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-notifications}
    depends_on:
      auth-service:
        condition: service_healthy
      tasks-service:
        condition: service_healthy
      notifications-service:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - proxy-network
      - taskflow-backend
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # Auth Service
  # ================================
  auth-service:
    build: ./apps/auth-service
    container_name: taskflow-auth-service
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=auth_service
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-15m}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN:-7d}
      - CORS_ORIGIN=${CORS_ORIGIN}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - taskflow-backend
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # Tasks Service
  # ================================
  tasks-service:
    build: ./apps/tasks-service
    container_name: taskflow-tasks-service
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=tasks_service
      - JWT_SECRET=${JWT_SECRET}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-task-events}
      - ALLOWED_ORIGINS=${CORS_ORIGIN}
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - taskflow-backend
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3002/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # Notifications Service
  # ================================
  notifications-service:
    build: ./apps/notifications-service
    container_name: taskflow-notifications-service
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=notifications_service
      - JWT_SECRET=${JWT_SECRET}
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE:-task-events}
      - RABBITMQ_WEBSOCKET_QUEUE=notifications
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - taskflow-backend
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:3003/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # PostgreSQL Database
  # ================================
  postgres:
    image: postgres:16-alpine
    container_name: taskflow-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql
    networks:
      - taskflow-backend
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USERNAME}']
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # RabbitMQ Message Broker
  # ================================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: taskflow-rabbitmq
    restart: unless-stopped
    ports:
      - '15672:15672'
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - proxy-network
      - taskflow-backend
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

# ================================
# Volumes
# ================================
volumes:
  postgres_data:
    driver: local
  rabbitmq_data:
    driver: local

# ================================
# Networks
# ================================
networks:
  proxy-network:
    external: true
  taskflow-backend:
    driver: bridge
